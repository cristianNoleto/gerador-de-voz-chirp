<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Est√∫dio de Voz Simples</title>
    <style>
        :root { --accent-color: #4285F4; --bg-light: #f8f9fa; --border-color: #dee2e6; --danger-color: #db4437; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; background-color: var(--bg-light); color: #212529; }
        h1, h2 { text-align: center; color: var(--accent-color); }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { font-weight: bold; margin-bottom: 8px; display: block; font-size: 14px; }
        select, button { font-family: inherit; font-size: 16px; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; width: 100%; }
        textarea { width: 100%; height: 250px; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid var(--border-color); resize: vertical; }
        button { cursor: pointer; color: white; transition: background-color 0.2s; border: none; }
        button:disabled { background-color: #9E9E9E; cursor: not-allowed; }
        .filter-buttons { display: flex; gap: 8px; }
        .filter-btn { padding: 8px 16px; font-size: 14px; color: #333; background-color: #e9ecef; flex-grow: 1; border: 1px solid var(--border-color); }
        .filter-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .flex-row { display: flex; align-items: center; gap: 8px; }
        #generateBtn { background-color: #34A853; margin-top: 20px; }
        .action-btn { flex-shrink: 0; width: auto; padding: 12px 14px; }
        #previewPlayBtn { background-color: var(--accent-color); }
        #previewStopBtn { background-color: var(--danger-color); }
        .rate-control { display: flex; align-items: center; gap: 15px; margin-top: 20px; }
        .rate-control input[type="range"] { flex-grow: 1; padding: 0;}
        .rate-control span { font-weight: bold; font-family: monospace; }
        #historyList { list-style: none; padding: 0; margin-top: 20px; }
        .history-item { display: flex; align-items: center; background: #f1f3f5; padding: 10px; border-radius: 6px; margin-bottom: 8px; gap: 10px; }
        .history-item audio { flex-grow: 1; }
        .delete-btn { background-color: var(--danger-color); flex-shrink: 0; width: auto; padding: 8px 12px; font-size: 14px; }
        .char-counter { text-align: right; font-size: 14px; color: #6c757d; margin-top: 5px; }
        .char-counter.error { color: var(--danger-color); font-weight: bold; }
        .info-icon { position: relative; display: inline-block; cursor: pointer; color: var(--accent-color); font-weight: bold; margin-left: 5px; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; border: 1px solid var(--accent-color); }
        .info-icon .tooltip-text { visibility: hidden; width: 350px; background-color: #555; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -175px; opacity: 0; transition: opacity 0.3s; font-weight: normal; font-size: 14px; }
        .info-icon:hover .tooltip-text { visibility: visible; opacity: 1; }
        .info-icon .tooltip-text ul { padding-left: 20px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Est√∫dio de Voz</h1>

    <div class="container">
        <div class="grid-container">
            <div><label for="languageSelect">Idioma</label><select id="languageSelect"></select></div>
            <div><label>Filtrar por G√™nero</label><div id="genderFilters" class="filter-buttons"><button class="filter-btn active" data-filter="Any">Qualquer</button><button class="filter-btn" data-filter="Feminino">Feminino</button><button class="filter-btn" data-filter="Masculino">Masculino</button></div></div>
        </div>
        <div><label for="voiceSelect">Voz</label><div class="flex-row"><select id="voiceSelect"></select><button id="previewPlayBtn" class="action-btn" title="Ouvir amostra">‚ñ∂</button><button id="previewStopBtn" class="action-btn" title="Parar amostra">‚ñ†</button></div></div>
        <div class="rate-control"><label for="rateSlider">Velocidade:</label><input type="range" id="rateSlider" min="0.25" max="2.0" value="1.0" step="0.05"><span id="rateValue">1.00x</span></div>
        <div style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="textInput" style="margin-bottom: 0;">Texto para Gera√ß√£o</label>
                <div class="info-icon">?
                    <div class="tooltip-text"><b>Dicas para uma Fala Natural:</b><ul><li>Use <b>v√≠rgulas (,)</b> para pausas curtas e <b>pontos (.)</b> para pausas mais longas.</li><li>Para pausas personalizadas, use as tags: <code>[pause short]</code> ou <code>[pause long]</code>.</li><li>Escreva como voc√™ fala, usando uma linguagem mais conversacional.</li></ul></div>
                </div>
            </div>
            <textarea id="textInput" placeholder="Digite seu texto aqui..."></textarea>
            <div id="charCounter" class="char-counter">0 / 5000</div>
        </div>
        <button id="generateBtn">Gerar √Åudio</button>
        <div id="status" style="text-align: center; color: #EA4335; font-weight: bold; height: 22px; margin-top: 10px;"></div>
        <div id="mainAudioContainer" style="margin-top: 20px;"></div>
    </div>

    <div class="container">
        <h2>Hist√≥rico de √Åudios</h2>
        <ul id="historyList"></ul>
    </div>

    <script>
        const API_DATA = {
            LANGUAGES: {
                "pt-BR": "Portugu√™s (BR)", "en-US": "Ingl√™s (US)", "en-GB": "Ingl√™s (UK)", "es-ES": "Espanhol (ES)", "it-IT": "Italiano", "de-DE": "Alem√£o",
                "fr-FR": "Franc√™s", "ja-JP": "Japon√™s", "ko-KR": "Coreano", "ru-RU": "Russo", "cmn-CN": "Mandarim", "hi-IN": "H√≠ndi", "ar-XA": "√Årabe",
                "bn-IN": "Bengali", "da-DK": "Dinamarqu√™s", "nl-BE": "Holand√™s (BE)", "nl-NL": "Holand√™s (NL)", "en-AU": "Ingl√™s (AU)", "en-IN": "Ingl√™s (IN)",
                "fi-FI": "Finland√™s", "fr-CA": "Franc√™s (CA)", "gu-IN": "Gujarati", "id-ID": "Indon√©sio", "kn-IN": "Canar√™s", "ml-IN": "Malaiala",
                "mr-IN": "Marati", "nb-NO": "Noruegu√™s", "pl-PL": "Polon√™s", "sv-SE": "Sueco", "sw-KE": "Sua√≠li", "ta-IN": "T√¢mil", "te-IN": "Telugo",
                "th-TH": "Tailand√™s", "tr-TR": "Turco", "uk-UA": "Ucraniano", "ur-IN": "Urdu", "vi-VN": "Vietnamita", "es-US": "Espanhol (US)"
            },
            VOICES: [
                { name: "Aoede", gender: "Feminino" }, { name: "Leda", gender: "Feminino" }, { name: "Callirrhoe", gender: "Feminino" }, { name: "Charon", gender: "Masculino" },
                { name: "Orus", gender: "Masculino" }, { name: "Algenib", gender: "Masculino" }, { name: "Kore", gender: "Feminino" }, { name: "Zephyr", gender: "Feminino" },
                { name: "Gacrux", gender: "Feminino" }, { name: "Puck", gender: "Masculino" }, { name: "Fenrir", gender: "Masculino" }, { name: "Achird", gender: "Masculino" },
                { name: "Erinome", gender: "Feminino" }, { name: "Despina", gender: "Feminino" }, { name: "Autonoe", gender: "Feminino" }, { name: "Enceladus", gender: "Masculino" },
                { name: "Iapetus", gender: "Masculino" }
            ]
        };

        const dom = {};
        Object.assign(dom, {
            generateBtn: document.getElementById('generateBtn'), textInput: document.getElementById('textInput'), voiceSelect: document.getElementById('voiceSelect'), languageSelect: document.getElementById('languageSelect'),
            mainAudioContainer: document.getElementById('mainAudioContainer'), historyList: document.getElementById('historyList'), status: document.getElementById('status'), genderFilters: document.getElementById('genderFilters'),
            previewPlayBtn: document.getElementById('previewPlayBtn'), previewStopBtn: document.getElementById('previewStopBtn'),
            rateSlider: document.getElementById('rateSlider'), rateValue: document.getElementById('rateValue'),
            charCounter: document.getElementById('charCounter'),
        });

        const CHAR_LIMIT = 5000;
        let activeGenderFilter = "Any";
        let previewAudio = null;

        function updateCharCounter() {
            const currentLength = dom.textInput.value.length;
            dom.charCounter.textContent = `${currentLength} / ${CHAR_LIMIT}`;
            const isOverLimit = currentLength > CHAR_LIMIT;
            dom.charCounter.classList.toggle('error', isOverLimit);
            dom.generateBtn.disabled = isOverLimit;
        }

        function populateLanguages() {
            const sortedLanguages = Object.entries(API_DATA.LANGUAGES).sort((a, b) => a[1].localeCompare(b[1]));
            sortedLanguages.forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code; option.textContent = name;
                if (code === 'pt-BR') option.selected = true;
                dom.languageSelect.appendChild(option);
            });
        }

        function filterAndPopulateVoices() {
            dom.voiceSelect.innerHTML = '';
            const filteredVoices = API_DATA.VOICES.filter(voice => activeGenderFilter === 'Any' || voice.gender === activeGenderFilter);
            filteredVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.gender.substring(0, 1)})`;
                dom.voiceSelect.appendChild(option);
            });
        }

        async function updateHistoryList() {
            try {
                const response = await fetch('/history-list');
                const files = await response.json();
                dom.historyList.innerHTML = files.length > 0
                    ? files.map(file => `<li class="history-item"><span>${file}</span><audio controls src="/history/${file}"></audio><button class="delete-btn" data-filename="${file}" title="Excluir √°udio">üóëÔ∏è</button></li>`).join('')
                    : '<li>Nenhum √°udio no hist√≥rico.</li>';
            } catch (error) { console.error("Erro ao carregar hist√≥rico:", error); }
        }
        
        // FUN√á√ÉO DE LIMPEZA CENTRALIZADA (A CORRE√á√ÉO)
        function stopPreview() {
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.src = ''; // Previne que continue baixando
                previewAudio = null;
            }
            // Sempre restaura o estado do bot√£o de play
            const btn = dom.previewPlayBtn;
            if (btn.disabled) {
                btn.disabled = false;
                btn.textContent = '‚ñ∂';
            }
        }
        
        dom.textInput.addEventListener('input', updateCharCounter);
        dom.rateSlider.addEventListener('input', () => { dom.rateValue.textContent = parseFloat(dom.rateSlider.value).toFixed(2) + 'x'; });
        
        dom.genderFilters.addEventListener('click', (e) => {
            const btn = e.target.closest('.filter-btn');
            if (!btn) return;
            activeGenderFilter = btn.dataset.filter;
            dom.genderFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterAndPopulateVoices();
        });

        dom.previewPlayBtn.addEventListener('click', async () => {
            stopPreview(); // Garante que qualquer √°udio anterior pare
            const btn = dom.previewPlayBtn;
            btn.disabled = true;
            btn.textContent = '...';
            dom.status.textContent = '';
            try {
                const response = await fetch('/preview-voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language: dom.languageSelect.value, voice: dom.voiceSelect.value })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                const data = await response.json();
                previewAudio = new Audio(`data:audio/mpeg;base64,${data.audio_content}`);
                previewAudio.play();
                previewAudio.onended = stopPreview; // Limpa quando termina
                previewAudio.onerror = () => {
                    dom.status.textContent = 'Erro ao tocar amostra.';
                    stopPreview(); // Limpa em caso de erro
                };
            } catch (error) {
                dom.status.textContent = 'Erro: ' + error.message;
                stopPreview(); // Limpa em caso de falha na requisi√ß√£o
            }
        });

        dom.previewStopBtn.addEventListener('click', stopPreview);

        dom.historyList.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (!deleteBtn) return;
            const filename = deleteBtn.dataset.filename;
            if (!confirm(`Tem certeza que deseja excluir o √°udio "${filename}"?`)) return;
            try {
                deleteBtn.textContent = '...';
                deleteBtn.disabled = true;
                const response = await fetch(`/history/delete/${filename}`, { method: 'DELETE' });
                if (!response.ok) throw new Error((await response.json()).error || 'Falha ao excluir.');
                deleteBtn.closest('.history-item').remove();
            } catch (error) {
                dom.status.textContent = `Erro ao excluir: ${error.message}`;
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.disabled = false;
            }
        });

        dom.generateBtn.addEventListener('click', async () => {
            if (!dom.textInput.value.trim()) { dom.status.textContent = "Digite um texto."; return; }
            if (dom.textInput.value.length > CHAR_LIMIT) { dom.status.textContent = `O texto excede o limite de ${CHAR_LIMIT} caracteres.`; return; }
            dom.status.textContent = 'Gerando...';
            dom.generateBtn.disabled = true;
            try {
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: dom.textInput.value,
                        language: dom.languageSelect.value,
                        voice: dom.voiceSelect.value,
                        speaking_rate: parseFloat(dom.rateSlider.value)
                    })
                });
                if (!response.ok) throw new Error((await response.json()).error);
                const data = await response.json();
                dom.mainAudioContainer.innerHTML = `<audio controls autoplay src="${data.audio_url}"></audio>`;
                dom.status.textContent = '';
                await updateHistoryList();
            } catch (error) {
                dom.status.textContent = 'Erro: ' + error.message;
            } finally {
                // Reavalia se o bot√£o deve ser habilitado
                dom.generateBtn.disabled = dom.textInput.value.length > CHAR_LIMIT;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            populateLanguages();
            filterAndPopulateVoices();
            updateHistoryList();
            updateCharCounter();
        });
    </script>
</body>
</html>
